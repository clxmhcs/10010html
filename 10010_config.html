<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>联通余量(v4) 配置页</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 16px; background:#f7f7f7;}
  h2 { margin: 0 0 12px; }
  .status { padding:8px 12px; border-radius:8px; margin-bottom:12px; display:inline-block; font-size:14px;}
  .ok{ background:#e8f5e9; color:#1b5e20; }
  .bad{ background:#ffebee; color:#b71c1c; }
  .selectors { margin:10px 0 14px; }
  .selectors label { margin-right: 16px; font-weight: 600; }
  .pkg-item { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:10px 12px; margin:6px 0; }
  .btns { margin-top: 14px; }
  button { margin: 4px 6px 0 0; padding: 9px 16px; font-size: 15px; border: none; border-radius: 8px; }
  .save { background:#43a047; color:#fff; }
  .refresh { background:#1e88e5; color:#fff; }
  .disabled { opacity:.5; pointer-events:none; }
  #debug { margin-top:18px; font-size:12px; color:#555; white-space:pre-wrap; word-break:break-all; background:#eee; padding:10px; border-radius:8px;}
</style>
<script>
  alert("window.$boxjs = " + typeof window.$boxjs);
  // —— BoxJS 封装 ——
  async function getValue(key) {
    if (window.$boxjs) return await window.$boxjs.getValue(key);
    return ""; // 禁止用 localStorage 迷惑性读写
  }
  async function setValue(key, value) {
    if (window.$boxjs) return await window.$boxjs.setValue(value, key);
    throw new Error("未连接到 BoxJS，无法保存。请从 BoxJS 面板里的“外部配置页”打开本页。");
  }

  let pkgs = [];

  async function loadPage() {
    const connected = !!window.$boxjs;
    const st = document.getElementById("status");
    st.textContent = connected ? "已连接 BoxJS ✅（可读取/保存）" :
                                 "未连接 BoxJS ❌（请从 BoxJS 面板内点击外部配置页进入）";
    st.className = "status " + (connected ? "ok" : "bad");

    // 拉取真实 pkgs
    let pkgsStr = "";
    try {
      pkgsStr = await getValue("@ChinaUnicom.10010v4.pkgs");
      pkgs = JSON.parse(pkgsStr || "[]");
    } catch (e) {
      pkgs = [];
    }

    render();
    document.getElementById("debug").textContent =
      "当前 pkgs 原始 JSON：\n" + (pkgsStr || "(空)");
    // 只有连上了 BoxJS 才允许保存
    document.getElementById("btnSave").classList.toggle("disabled", !connected);
  }

  function render() {
    const list = document.getElementById("pkg-list");
    list.innerHTML = "";

    // 顶部三个集合选择器
    const selectors = document.createElement("div");
    selectors.className = "selectors";
    selectors.innerHTML = `
      <label><input type="checkbox" id="chk-domestic" onchange="applyGroup('国内')"> 国内流量</label>
      <label><input type="checkbox" id="chk-province" onchange="applyGroup('省内')"> 省内流量</label>
      <label><input type="checkbox" id="chk-xiaoqu" onchange="applyGroup('小区')"> 小区流量</label>
    `;
    list.appendChild(selectors);

    // 真实包列表
    if (!Array.isArray(pkgs) || pkgs.length === 0) {
      const tip = document.createElement("div");
      tip.style.cssText="padding:10px 12px;background:#fff3e0;border:1px solid #ffe0b2;border-radius:8px;";
      tip.textContent = "未读取到任何流量包。请先在 BoxJS 执行一次“手动执行查询（10010.js）”，再从订阅里的外部配置页打开本页面。";
      list.appendChild(tip);
      return;
    }

    pkgs.forEach(p=>{
      const div = document.createElement("div");
      div.className = "pkg-item";
      const remain = p.remain ?? "?";
      const total  = p.total  ?? "?";
      div.innerHTML = `<label><input type="checkbox" data-pkg value="${p.name}"> ${p.name} (${remain}/${total})</label>`;
      list.appendChild(div);
    });
  }

  // 勾选集合 → 下方对应关键词的包同步打勾/去勾
  function applyGroup(keyword){
    const checked = document.getElementById("chk-"+(
      keyword==="国内" ? "domestic" : keyword==="省内" ? "province" : "xiaoqu"
    )).checked;

    document.querySelectorAll('#pkg-list input[type="checkbox"][data-pkg]').forEach(i=>{
      if (i.value.includes(keyword)) i.checked = checked;
    });
  }

  // 保存：把当前被勾选的包写入到 config（三类）
  async function saveConfig(){
    const result = { domestic:[], province:[], custom:{"小区流量":[]} };
    document.querySelectorAll('#pkg-list input[type="checkbox"][data-pkg]:checked').forEach(i=>{
      if(i.value.includes("国内"))      result.domestic.push(i.value);
      else if(i.value.includes("省内")) result.province.push(i.value);
      else if(i.value.includes("小区")) result.custom["小区流量"].push(i.value);
    });
    await setValue("@ChinaUnicom.10010v4.config", JSON.stringify(result));
    alert("保存成功！");
  }
</script>
</head>
<body onload="loadPage()">
  <h2>联通余量(v4) 流量包选择</h2>
  <div id="status" class="status"></div>

  <div id="pkg-list"></div>

  <div class="btns">
    <button id="btnSave" class="save" onclick="saveConfig()">保存</button>
    <button class="refresh" onclick="loadPage()">刷新</button>
  </div>

  <div id="debug"></div>
</body>
</html>
